From 7a7177a3e54adcd89703c2992388a35cf091e4d5 Mon Sep 17 00:00:00 2001
From: William Woodall <william@osrfoundation.org>
Date: Wed, 23 Sep 2015 14:19:55 -0700
Subject: [PATCH 9/9] fix stage config file (even for saucy)

---
 CMakeLists.txt        | 28 +++++++++++++++++++---------
 stage-config.cmake.in |  2 +-
 2 files changed, 20 insertions(+), 10 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index 962d848..43df72b 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -155,15 +155,6 @@ ENDFOREACH(INC ${PC_INCLUDE_DIRS})
 CONFIGURE_FILE (${CMAKE_CURRENT_SOURCE_DIR}/stage.pc.in ${CMAKE_CURRENT_BINARY_DIR}/stage.pc @ONLY)
 INSTALL (FILES ${CMAKE_CURRENT_BINARY_DIR}/stage.pc DESTINATION ${PROJECT_LIB_DIR}/pkgconfig/)
 
-# Create the CMake module files
-CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/stage-config.cmake.in ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake @ONLY)
-# Also run it through file(GENERATE ...) to expand generator expressions.
-FILE (GENERATE
-  OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake
-  INPUT ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake)
-CONFIGURE_FILE (${CMAKE_CURRENT_SOURCE_DIR}/stage-config-version.cmake.in ${CMAKE_CURRENT_BINARY_DIR}/stage-config-version.cmake @ONLY)
-INSTALL (FILES ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake ${CMAKE_CURRENT_BINARY_DIR}/stage-config-version.cmake DESTINATION ${PROJECT_LIB_DIR}/cmake/${PROJECT_NAME})
-
 # Install catkin package.xml
 install(FILES package.xml DESTINATION share/stage)
 
@@ -191,6 +182,25 @@ IF ( BUILD_PLAYER_PLUGIN AND PLAYER_FOUND )
   ADD_SUBDIRECTORY(libstageplugin)
 ENDIF ( BUILD_PLAYER_PLUGIN AND PLAYER_FOUND )	 
 
+# Create the CMake module files (needs to be run after the stage target was created)
+if (${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION}.${CMAKE_PATCH_VERSION} GREATER 2.8.11)
+  # Use a generator expression if the version of cmake allows it.
+  set(STAGE_TARGET_NAME "$<TARGET_FILE_NAME:stage>")
+else()
+  # Otherwise use the LOCATION property of the target (this will produce a warning on newer versions of cmake)
+  get_property(location_ TARGET stage PROPERTY LOCATION)
+  get_filename_component(STAGE_TARGET_NAME "${location_}" NAME)
+  unset(location_)
+endif()
+CONFIGURE_FILE(${CMAKE_CURRENT_SOURCE_DIR}/stage-config.cmake.in ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake @ONLY)
+if (${CMAKE_MAJOR_VERSION}.${CMAKE_MINOR_VERSION}.${CMAKE_PATCH_VERSION} GREATER 2.8.11)
+  # Also run it through file(GENERATE ...) to expand generator expressions (if the version of cmake supports it).
+  FILE (GENERATE
+    OUTPUT ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake
+    INPUT ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake)
+endif()
+CONFIGURE_FILE (${CMAKE_CURRENT_SOURCE_DIR}/stage-config-version.cmake.in ${CMAKE_CURRENT_BINARY_DIR}/stage-config-version.cmake @ONLY)
+INSTALL (FILES ${CMAKE_CURRENT_BINARY_DIR}/stage-config.cmake ${CMAKE_CURRENT_BINARY_DIR}/stage-config-version.cmake DESTINATION ${PROJECT_LIB_DIR}/cmake/${PROJECT_NAME})
 
 # generate a cpack config file used to create packaged tarballs
 IF ( CPACK_CFG )
diff --git a/stage-config.cmake.in b/stage-config.cmake.in
index 8683807..676157c 100644
--- a/stage-config.cmake.in
+++ b/stage-config.cmake.in
@@ -8,7 +8,7 @@ set(STAGE_INCLUDE_DIRS "${stage_DIR}/../../../include/@PROJECT_NAME@-@APIVERSION
   "@OPENGL_INCLUDE_DIR@")
 list(REMOVE_DUPLICATES STAGE_INCLUDE_DIRS)
 set(STAGE_LIBRARIES 
-  "${stage_DIR}/../../../@PROJECT_LIB_DIR@/$<TARGET_FILE_NAME:stage>"
+  "${stage_DIR}/../../../@PROJECT_LIB_DIR@/@STAGE_TARGET_NAME@"
   "@FLTK_LIBRARIES@"
   "@OPENGL_gl_LIBRARIES@")
   
-- 
2.17.0

